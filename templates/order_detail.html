{% extends "base.html" %}
{% block content %}

<div style="margin-bottom:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
  <a href="/" class="btn btn-secondary">Dashboard</a>

  {% if order.last_run_id %}
    <a href="/run/{{ order.last_run_id }}" class="btn">
      ‚Üê Back to Run
    </a>
  {% endif %}
</div>

<div class="card">
  <div class="cardHeader">
    <div>
      <div class="crumbs">
        <a href="/">Dashboard</a> <span class="sep">‚Ä∫</span>
        <span>Order</span> <span class="sep">‚Ä∫</span>
        <b>PolyTex SO {{ order.sordernum }}</b>
      </div>

      <h2 style="margin:8px 0 0;">Order</h2>

      <p class="muted" style="margin:6px 0 0;">
        <b>PolyTex SO (Starts Here):</b> {{ order.sordernum }}<br>
        <b>StarPak SO:</b> {{ order.so_p2_num or "‚Äî" }}<br>
        {% if order.last_run_id %}
          <b>Run:</b>
          <a href="/run/{{ order.last_run_id }}">{{ order.last_run_id[:8] }}</a><br>
        {% endif %}
        Last updated: {{ order.updated_ts | ct }} (CT)
      </p>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <a class="btn" href="/order/{{ order.sordernum }}/retry">Retry Next Run</a>

      {% if order.status != "REMOVED" %}
        <form method="POST" action="{{ url_for('order_remove', sordernum=order.sordernum) }}" style="display:inline;">
          <button type="submit" class="btn btn-secondary"
            onclick="return confirm('Remove SO {{ order.sordernum }} from workflow? You can resume using Retry Next Run.')">
            Remove from Workflow
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<div class="grid">
  <div class="card">
    <h3 style="margin:0 0 10px;">Status</h3>
    <p style="margin:0;">
      {% if order.status == "COMPLETE" %}
        <span class="pill ok">COMPLETE</span>
      {% elif order.status == "FAILED" %}
        <span class="pill bad">FAILED</span>
      {% elif order.status == "HOLD" %}
        <span class="pill warn">HOLD</span>
      {% elif order.status == "REMOVED" %}
        <span class="pill bad">REMOVED</span>
      {% else %}
        <span class="pill warn">{{ order.status }}</span>
      {% endif %}
      <span class="muted" style="margin-left:10px;">Step: <b>{{ order.last_step }}</b></span>
    </p>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Created Records</h3>
    <div class="tableWrap">
      <table style="min-width: 560px;">
        <tr>
          <td><b>PolyTex Item (Plant 4)</b></td>
          <td class="nowrap" title="{{ order.polytex_item_code }}">{{ order.polytex_item_code or "‚Äî" }}</td>
        </tr>
        <tr><td><b>PolyTex Job (Plant 4)</b></td><td>{{ order.job_p4_code or "‚Äî" }}</td></tr>
        <tr><td><b>PolyTex PO (Plant 4)</b></td><td>{{ order.po_p4_num or "‚Äî" }}</td></tr>
        <tr><td><b>StarPak SO (Plant 2)</b></td><td>{{ order.so_p2_num or "‚Äî" }}</td></tr>
        <tr><td><b>ShipReq (Plant 2)</b></td><td>{{ order.shipreq_p2 or "‚Äî" }}</td></tr>
        <tr><td><b>StarPak Job (Plant 2)</b></td><td>{{ order.job_p2_code or "‚Äî" }}</td></tr>
      </table>
    </div>

    <div class="muted small" style="margin-top:10px;">
      <b>Plant Reference:</b> PolyTex = Plant 4 ‚Ä¢ StarPak = Plant 2
    </div>
  </div>
</div>

{# ==========================================================
   ‚úÖ Last Error (improved: show true Radius error + raw)
   ========================================================== #}
{% if order.last_error_summary or order.last_api_error_message or order.last_api_messages or order.last_api_raw %}
<div class="card">
  <div class="cardHeader">
    <h3 style="margin:0; color: var(--bad);">Last Error</h3>
    <span class="pill bad">ATTENTION</span>
  </div>

{# --- Workflow / API error headline (show something even if workflow msg is empty) --- #}
{% if order.last_error_summary or order.last_api_error_message %}
  <p style="margin:0 0 10px;">
    <b>Workflow Error:</b>
    {{ order.last_error_summary or order.last_api_error_message }}
  </p>
{% endif %}

{# --- API details table --- #}
{% if order.last_api_error_message or order.last_api_entity or order.last_api_status %}
  <h3 style="margin:14px 0 8px;">API Details</h3>
  <div class="tableWrap">
    <table style="min-width: 560px;">
      {% if order.last_api_entity %}
        <tr><td style="width:180px;"><b>API Entity</b></td><td>{{ order.last_api_entity }}</td></tr>
      {% endif %}
      {% if order.last_api_status is not none %}
        <tr><td><b>API Status</b></td><td>{{ order.last_api_status }}</td></tr>
      {% endif %}
      {% if order.last_api_error_message %}
        <tr><td><b>API Error</b></td><td>{{ order.last_api_error_message }}</td></tr>
      {% endif %}
    </table>
  </div>
{% endif %}


{% if order.last_api_messages and order.last_api_messages != "[]" %}
  <h3 style="margin:14px 0 8px;">API Messages</h3>
  <pre style="white-space:pre-wrap;">{{ order.last_api_messages }}</pre>
{% endif %}


  {% if order.last_api_raw %}
    <div style="margin-top:14px;">
      <details>
        <summary style="cursor:pointer; font-weight:700; font-size:14px; display:flex; align-items:center; gap:8px;">
          üßæ Raw API Response (stored / may be truncated)
          <span class="muted small" style="font-weight:400;">Click to expand</span>
        </summary>
        <pre style="white-space:pre-wrap; margin-top:10px;">{{ order.last_api_raw }}</pre>
      </details>
    </div>
  {% endif %}
</div>
{% endif %}

{% endblock %}
